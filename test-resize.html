<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ë””ì˜¤ ë‹¤ì¤‘ í•´ìƒë„ ë³€í™˜</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007AFF;
            padding-bottom: 10px;
        }
        .upload-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
        }
        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .result-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }
        .result-item h3 {
            margin-top: 0;
            color: #007AFF;
        }
        .result-item video {
            width: 100%;
            border-radius: 4px;
        }
        .info {
            background: #e8f4ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .size-info {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
        #progress {
            display: none;
            margin: 20px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ ë¹„ë””ì˜¤ ë‹¤ì¤‘ í•´ìƒë„ ë³€í™˜</h1>
        
        <div class="upload-section">
            <input type="file" id="videoFile" accept="video/*">
            <p>MP4 ë¹„ë””ì˜¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        </div>

        <div class="bitrate-section" style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px;">
            <h3 style="margin-top: 0;">ğŸ›ï¸ ì»¤ìŠ¤í…€ ì„¤ì •</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div>
                    <label for="customResolution" style="display: block; margin-bottom: 5px; font-weight: 600;">í•´ìƒë„:</label>
                    <select id="customResolution" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">í”„ë¦¬ì…‹ ì‚¬ìš©</option>
                        <option value="144p">144p (256Ã—144)</option>
                        <option value="240p">240p (426Ã—240)</option>
                        <option value="320p">320p (480Ã—320)</option>
                        <option value="480p">480p (854Ã—480)</option>
                        <option value="720p">720p HD (1280Ã—720)</option>
                        <option value="1080p">1080p FHD (1920Ã—1080)</option>
                    </select>
                </div>
                <div>
                    <label for="videoBitrate" style="display: block; margin-bottom: 5px; font-weight: 600;">ë¹„ë””ì˜¤ ë¹„íŠ¸ë ˆì´íŠ¸:</label>
                    <input type="text" id="videoBitrate" placeholder="ì˜ˆ: 500k, 2M" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666;">k=kbps, M=Mbps</small>
                </div>
                <div>
                    <label for="audioBitrate" style="display: block; margin-bottom: 5px; font-weight: 600;">ì˜¤ë””ì˜¤ ë¹„íŠ¸ë ˆì´íŠ¸:</label>
                    <input type="text" id="audioBitrate" placeholder="ì˜ˆ: 128k, 192k" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666;">ì¼ë°˜: 128k, ê³ í’ˆì§ˆ: 192k</small>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="convertWithCustomSettings()" style="background: #28a745; width: 100%;">ì»¤ìŠ¤í…€ ì„¤ì •ìœ¼ë¡œ ë³€í™˜</button>
            </div>
        </div>

        <div class="buttons">
            <button onclick="convertAllResolutions()" style="background: #007AFF; padding: 15px 40px; font-size: 18px;">ğŸ¬ ì „ì²´ í•´ìƒë„ ë³€í™˜ (144p, 360p, 720p)</button>
            <button onclick="convertToGif()">GIF ë³€í™˜</button>
        </div>

        <div id="progress">
            <div>ì²˜ë¦¬ ì¤‘...</div>
        </div>

        <div class="info">
            <strong>í•´ìƒë„ ì„¤ëª…:</strong><br>
            â€¢ <strong>144p</strong>: 256Ã—144 í”½ì…€ (ìµœì € í™”ì§ˆ, ë§¤ìš° ì‘ì€ íŒŒì¼)<br>
            â€¢ <strong>360p</strong>: 640Ã—360 í”½ì…€ (í‘œì¤€ í™”ì§ˆ, ì¤‘ê°„ íŒŒì¼)<br>
            â€¢ <strong>720p HD</strong>: 1280Ã—720 í”½ì…€ (HD í’ˆì§ˆ)<br>
            â€¢ <strong>GIF</strong>: 320px ë„ˆë¹„, 10fps, ìµœëŒ€ 10ì´ˆ<br>
            â€¢ <strong>ì „ì²´ ë³€í™˜</strong>: 144p, 360p, 720pë¥¼ ë™ì‹œì— ë³€í™˜
        </div>

        <div id="results" class="results"></div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:3000';
        let selectedFile = null;
        let originalInfo = null;

        document.getElementById('videoFile').addEventListener('change', async (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                // ì›ë³¸ ë¹„ë””ì˜¤ ì •ë³´ í‘œì‹œ
                const originalUrl = URL.createObjectURL(selectedFile);
                originalInfo = {
                    name: selectedFile.name,
                    size: selectedFile.size,
                    url: originalUrl
                };
                
                // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
                document.getElementById('results').innerHTML = '';
                
                // ì›ë³¸ í‘œì‹œ
                addResult('ì›ë³¸ ë¹„ë””ì˜¤', originalUrl, selectedFile.size, 'original');
            }
        });

        async function convertAllResolutions() {
            if (!selectedFile) {
                alert('ë¹„ë””ì˜¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            document.getElementById('progress').style.display = 'block';
            document.getElementById('progress').innerHTML = '<div>ğŸ”„ 144p, 360p, 720p ë™ì‹œ ë³€í™˜ ì¤‘...</div>';

            const formData = new FormData();
            formData.append('video', selectedFile);

            try {
                const response = await fetch(`${SERVER_URL}/convert/multi-resolution`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('progress').innerHTML = `<div>âœ… ë³€í™˜ ì™„ë£Œ! ì´ ì‹œê°„: ${data.totalConversionTime.toFixed(2)}ì´ˆ</div>`;
                    
                    // ê° í•´ìƒë„ë³„ ê²°ê³¼ í‘œì‹œ
                    data.results.forEach(result => {
                        addResult(
                            `${result.resolution} ë³€í™˜`,
                            `${SERVER_URL}${result.outputUrl}`,
                            result.fileSize,
                            result.resolution,
                            {
                                ...result.metadata,
                                conversionTime: data.totalConversionTime
                            }
                        );
                    });
                    
                    setTimeout(() => {
                        document.getElementById('progress').style.display = 'none';
                    }, 3000);
                } else {
                    alert('ë³€í™˜ ì‹¤íŒ¨: ' + (data.error || 'Unknown error'));
                    document.getElementById('progress').style.display = 'none';
                }
            } catch (error) {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                document.getElementById('progress').style.display = 'none';
            }
        }

        // ì´ì „ ê°œë³„ ë³€í™˜ í•¨ìˆ˜ë“¤ì€ ì œê±°ë¨
        
        async function convertWithCustomSettings() {
            if (!selectedFile) {
                alert('ë¹„ë””ì˜¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            const resolution = document.getElementById('customResolution').value;
            const videoBitrate = document.getElementById('videoBitrate').value;
            const audioBitrate = document.getElementById('audioBitrate').value;

            if (!resolution && !videoBitrate) {
                alert('í•´ìƒë„ë‚˜ ë¹„íŠ¸ë ˆì´íŠ¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”');
                return;
            }

            document.getElementById('progress').style.display = 'block';

            const formData = new FormData();
            formData.append('video', selectedFile);
            
            if (resolution) {
                formData.append('resolution', resolution);
            }
            if (videoBitrate) {
                formData.append('videoBitrate', videoBitrate);
            }
            if (audioBitrate) {
                formData.append('audioBitrate', audioBitrate);
            }

            try {
                const response = await fetch(`${SERVER_URL}/convert/video`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const fullUrl = `${SERVER_URL}${result.outputUrl}`;
                    
                    // íŒŒì¼ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
                    const sizeResponse = await fetch(fullUrl, { method: 'HEAD' });
                    const contentLength = sizeResponse.headers.get('content-length');
                    
                    const customLabel = `ì»¤ìŠ¤í…€ (${resolution || 'ì›ë³¸'}, V:${videoBitrate || 'ê¸°ë³¸'}, A:${audioBitrate || 'ê¸°ë³¸'})`;
                    
                    addResult(
                        customLabel,
                        fullUrl,
                        parseInt(contentLength) || 0,
                        'custom',
                        result.metadata
                    );
                } else {
                    alert('ë³€í™˜ ì‹¤íŒ¨: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            } finally {
                document.getElementById('progress').style.display = 'none';
            }
        }

        async function convertToGif() {
            if (!selectedFile) {
                alert('ë¹„ë””ì˜¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            document.getElementById('progress').style.display = 'block';

            const formData = new FormData();
            formData.append('video', selectedFile);
            formData.append('fps', '10');
            formData.append('scale', '320');
            formData.append('duration', '10');

            try {
                const response = await fetch(`${SERVER_URL}/convert/to-gif`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const fullUrl = `${SERVER_URL}${result.outputUrl}`;
                    
                    // GIF ê²°ê³¼ í‘œì‹œ
                    addGifResult('GIF ë³€í™˜', fullUrl, result.metadata);
                } else {
                    alert('GIF ë³€í™˜ ì‹¤íŒ¨: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            } finally {
                document.getElementById('progress').style.display = 'none';
            }
        }

        function addResult(title, url, fileSize, type, metadata = {}) {
            const resultsDiv = document.getElementById('results');
            
            // ê¸°ì¡´ ê°™ì€ íƒ€ì… ê²°ê³¼ ì œê±°
            const existing = document.getElementById(`result-${type}`);
            if (existing) {
                existing.remove();
            }
            
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.id = `result-${type}`;
            
            const resolution = metadata?.resolution || type;
            
            resultItem.innerHTML = `
                <h3>${title}</h3>
                <video controls src="${url}"></video>
                <div class="size-info">
                    <strong>í•´ìƒë„:</strong> ${resolution}<br>
                    <strong>íŒŒì¼ í¬ê¸°:</strong> ${formatFileSize(fileSize)}<br>
                    ${metadata?.conversionTime ? `<strong>ë³€í™˜ ì‹œê°„:</strong> ${metadata.conversionTime.toFixed(2)}ì´ˆ<br>` : ''}
                    ${fileSize && originalInfo ? `<strong>ì••ì¶•ë¥ :</strong> ${Math.round((fileSize / originalInfo.size) * 100)}%` : ''}
                </div>
                <a href="${url}" download style="color: #007AFF; text-decoration: none;">â¬‡ ë‹¤ìš´ë¡œë“œ</a>
            `;
            
            resultsDiv.appendChild(resultItem);
        }

        function addGifResult(title, url, metadata = {}) {
            const resultsDiv = document.getElementById('results');
            
            const existing = document.getElementById('result-gif');
            if (existing) {
                existing.remove();
            }
            
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.id = 'result-gif';
            
            resultItem.innerHTML = `
                <h3>${title}</h3>
                <img src="${url}" style="width: 100%; border-radius: 4px;">
                <div class="size-info">
                    <strong>í˜•ì‹:</strong> GIF<br>
                    <strong>í¬ê¸°:</strong> ${metadata.scale || 320}px<br>
                    <strong>FPS:</strong> ${metadata.fps || 10}<br>
                    ${metadata.size ? `<strong>íŒŒì¼ í¬ê¸°:</strong> ${formatFileSize(metadata.size)}<br>` : ''}
                    ${metadata.conversionTime ? `<strong>ë³€í™˜ ì‹œê°„:</strong> ${metadata.conversionTime.toFixed(2)}ì´ˆ` : ''}
                </div>
                <a href="${url}" download style="color: #007AFF; text-decoration: none;">â¬‡ ë‹¤ìš´ë¡œë“œ</a>
            `;
            
            resultsDiv.appendChild(resultItem);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>