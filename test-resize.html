<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비디오 다중 해상도 변환</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007AFF;
            padding-bottom: 10px;
        }
        .upload-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
        }
        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .result-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }
        .result-item h3 {
            margin-top: 0;
            color: #007AFF;
        }
        .result-item video {
            width: 100%;
            border-radius: 4px;
        }
        .info {
            background: #e8f4ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .size-info {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
        #progress {
            display: none;
            margin: 20px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 비디오 다중 해상도 변환</h1>
        
        <div class="upload-section">
            <input type="file" id="videoFile" accept="video/*">
            <p>MP4 비디오를 선택하세요</p>
        </div>

        <div class="bitrate-section" style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px;">
            <h3 style="margin-top: 0;">🎛️ 커스텀 설정</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div>
                    <label for="customResolution" style="display: block; margin-bottom: 5px; font-weight: 600;">해상도:</label>
                    <select id="customResolution" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">프리셋 사용</option>
                        <option value="144p">144p (256×144)</option>
                        <option value="240p">240p (426×240)</option>
                        <option value="320p">320p (480×320)</option>
                        <option value="480p">480p (854×480)</option>
                        <option value="720p">720p HD (1280×720)</option>
                        <option value="1080p">1080p FHD (1920×1080)</option>
                    </select>
                </div>
                <div>
                    <label for="videoBitrate" style="display: block; margin-bottom: 5px; font-weight: 600;">비디오 비트레이트:</label>
                    <input type="text" id="videoBitrate" placeholder="예: 500k, 2M" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666;">k=kbps, M=Mbps</small>
                </div>
                <div>
                    <label for="audioBitrate" style="display: block; margin-bottom: 5px; font-weight: 600;">오디오 비트레이트:</label>
                    <input type="text" id="audioBitrate" placeholder="예: 128k, 192k" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666;">일반: 128k, 고품질: 192k</small>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="convertWithCustomSettings()" style="background: #28a745; width: 100%;">커스텀 설정으로 변환</button>
            </div>
        </div>

        <div class="buttons">
            <button onclick="convertAllResolutions()" style="background: #007AFF; padding: 15px 40px; font-size: 18px;">🎬 전체 해상도 변환 (144p, 360p, 720p)</button>
            <button onclick="convertToGif()">GIF 변환</button>
        </div>

        <div id="progress">
            <div>처리 중...</div>
        </div>

        <div class="info">
            <strong>해상도 설명:</strong><br>
            • <strong>144p</strong>: 256×144 픽셀 (최저 화질, 매우 작은 파일)<br>
            • <strong>360p</strong>: 640×360 픽셀 (표준 화질, 중간 파일)<br>
            • <strong>720p HD</strong>: 1280×720 픽셀 (HD 품질)<br>
            • <strong>GIF</strong>: 320px 너비, 10fps, 최대 10초<br>
            • <strong>전체 변환</strong>: 144p, 360p, 720p를 동시에 변환
        </div>

        <div id="results" class="results"></div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:3000';
        let selectedFile = null;
        let originalInfo = null;

        document.getElementById('videoFile').addEventListener('change', async (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                // 원본 비디오 정보 표시
                const originalUrl = URL.createObjectURL(selectedFile);
                originalInfo = {
                    name: selectedFile.name,
                    size: selectedFile.size,
                    url: originalUrl
                };
                
                // 결과 영역 초기화
                document.getElementById('results').innerHTML = '';
                
                // 원본 표시
                addResult('원본 비디오', originalUrl, selectedFile.size, 'original');
            }
        });

        async function convertAllResolutions() {
            if (!selectedFile) {
                alert('비디오를 선택해주세요');
                return;
            }

            document.getElementById('progress').style.display = 'block';
            document.getElementById('progress').innerHTML = '<div>🔄 144p, 360p, 720p 동시 변환 중...</div>';

            const formData = new FormData();
            formData.append('video', selectedFile);

            try {
                const response = await fetch(`${SERVER_URL}/convert/multi-resolution`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('progress').innerHTML = `<div>✅ 변환 완료! 총 시간: ${data.totalConversionTime.toFixed(2)}초</div>`;
                    
                    // 각 해상도별 결과 표시
                    data.results.forEach(result => {
                        addResult(
                            `${result.resolution} 변환`,
                            `${SERVER_URL}${result.outputUrl}`,
                            result.fileSize,
                            result.resolution,
                            {
                                ...result.metadata,
                                conversionTime: data.totalConversionTime
                            }
                        );
                    });
                    
                    setTimeout(() => {
                        document.getElementById('progress').style.display = 'none';
                    }, 3000);
                } else {
                    alert('변환 실패: ' + (data.error || 'Unknown error'));
                    document.getElementById('progress').style.display = 'none';
                }
            } catch (error) {
                alert('오류 발생: ' + error.message);
                document.getElementById('progress').style.display = 'none';
            }
        }

        // 이전 개별 변환 함수들은 제거됨
        
        async function convertWithCustomSettings() {
            if (!selectedFile) {
                alert('비디오를 선택해주세요');
                return;
            }

            const resolution = document.getElementById('customResolution').value;
            const videoBitrate = document.getElementById('videoBitrate').value;
            const audioBitrate = document.getElementById('audioBitrate').value;

            if (!resolution && !videoBitrate) {
                alert('해상도나 비트레이트를 설정해주세요');
                return;
            }

            document.getElementById('progress').style.display = 'block';

            const formData = new FormData();
            formData.append('video', selectedFile);
            
            if (resolution) {
                formData.append('resolution', resolution);
            }
            if (videoBitrate) {
                formData.append('videoBitrate', videoBitrate);
            }
            if (audioBitrate) {
                formData.append('audioBitrate', audioBitrate);
            }

            try {
                const response = await fetch(`${SERVER_URL}/convert/video`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const fullUrl = `${SERVER_URL}${result.outputUrl}`;
                    
                    // 파일 크기 가져오기
                    const sizeResponse = await fetch(fullUrl, { method: 'HEAD' });
                    const contentLength = sizeResponse.headers.get('content-length');
                    
                    const customLabel = `커스텀 (${resolution || '원본'}, V:${videoBitrate || '기본'}, A:${audioBitrate || '기본'})`;
                    
                    addResult(
                        customLabel,
                        fullUrl,
                        parseInt(contentLength) || 0,
                        'custom',
                        result.metadata
                    );
                } else {
                    alert('변환 실패: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('오류 발생: ' + error.message);
            } finally {
                document.getElementById('progress').style.display = 'none';
            }
        }

        async function convertToGif() {
            if (!selectedFile) {
                alert('비디오를 선택해주세요');
                return;
            }

            document.getElementById('progress').style.display = 'block';

            const formData = new FormData();
            formData.append('video', selectedFile);
            formData.append('fps', '10');
            formData.append('scale', '320');
            formData.append('duration', '10');

            try {
                const response = await fetch(`${SERVER_URL}/convert/to-gif`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const fullUrl = `${SERVER_URL}${result.outputUrl}`;
                    
                    // GIF 결과 표시
                    addGifResult('GIF 변환', fullUrl, result.metadata);
                } else {
                    alert('GIF 변환 실패: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('오류 발생: ' + error.message);
            } finally {
                document.getElementById('progress').style.display = 'none';
            }
        }

        function addResult(title, url, fileSize, type, metadata = {}) {
            const resultsDiv = document.getElementById('results');
            
            // 기존 같은 타입 결과 제거
            const existing = document.getElementById(`result-${type}`);
            if (existing) {
                existing.remove();
            }
            
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.id = `result-${type}`;
            
            const resolution = metadata?.resolution || type;
            
            resultItem.innerHTML = `
                <h3>${title}</h3>
                <video controls src="${url}"></video>
                <div class="size-info">
                    <strong>해상도:</strong> ${resolution}<br>
                    <strong>파일 크기:</strong> ${formatFileSize(fileSize)}<br>
                    ${metadata?.conversionTime ? `<strong>변환 시간:</strong> ${metadata.conversionTime.toFixed(2)}초<br>` : ''}
                    ${fileSize && originalInfo ? `<strong>압축률:</strong> ${Math.round((fileSize / originalInfo.size) * 100)}%` : ''}
                </div>
                <a href="${url}" download style="color: #007AFF; text-decoration: none;">⬇ 다운로드</a>
            `;
            
            resultsDiv.appendChild(resultItem);
        }

        function addGifResult(title, url, metadata = {}) {
            const resultsDiv = document.getElementById('results');
            
            const existing = document.getElementById('result-gif');
            if (existing) {
                existing.remove();
            }
            
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.id = 'result-gif';
            
            resultItem.innerHTML = `
                <h3>${title}</h3>
                <img src="${url}" style="width: 100%; border-radius: 4px;">
                <div class="size-info">
                    <strong>형식:</strong> GIF<br>
                    <strong>크기:</strong> ${metadata.scale || 320}px<br>
                    <strong>FPS:</strong> ${metadata.fps || 10}<br>
                    ${metadata.size ? `<strong>파일 크기:</strong> ${formatFileSize(metadata.size)}<br>` : ''}
                    ${metadata.conversionTime ? `<strong>변환 시간:</strong> ${metadata.conversionTime.toFixed(2)}초` : ''}
                </div>
                <a href="${url}" download style="color: #007AFF; text-decoration: none;">⬇ 다운로드</a>
            `;
            
            resultsDiv.appendChild(resultItem);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>